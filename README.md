# jwkrotatekey
This utility will help you rotate keys and certs used by [Apigee Edge Microgateway](http://docs.apigee.com/microgateway/content/edge-microgateway-home) to sign/validate

## Pre-Requisites
* NodeJS
* OpenSSL
* Apigee Edge Account
* Apigee Edge Microgateway v2.4.7 or higher
* Apigee Edge Microgateway Configured and Setup

## Install
```
git clone https://github.com/srinandan/jwkrotatekey.git
cd jwkrotatekey
npm install .
```

## Usage
```
node index.js -o <org name> -e <env> -u <username> -p <password>
```

## Initial Setup
Apigee Edge Microgateway creates an [encrypted KeyValue Map](http://docs.apigee.com/api-services/reference/key-value-map-operations-policy#samples) to store the key and certificate at the time of running the [`edgemicro configure`](http://docs.apigee.com/microgateway/latest/setting-and-configuring-edge-microgateway) command.

At initial setup, there are four fields added to the Key Value Map:
```
private_key: <contains the RSA Private Key>
private_key_kid: <contains the KID for the private key; set to 1>
public_key: Certificate
public_key1: Public Key
public_key1_kid: 1 <same as private key kid>
```

You can see the public key by accessing:
```
HTTP GET https://{virtual-host}/edgemicro-auth/publicKey
```

### JWT Format
Here is a sample JWT (decoded) generated by Apigee Edge Microgateway:
Header
```
{
  "alg": "RS256",
  "typ": "JWT",
  "kid": "1"
}
```
NOTE: This is a JWT with signed with a private whose KID is 1

Payload:
```
{
  "api_product_list": [
    "Edgemicro HttpBin Product"
  ],
  "audience": "microgateway",
  "jti": "63e1c5b1-3495-40ac-a827-5f41f55bd228",
  "iss": "https://test.apigee.net/edgemicro-auth/token",
  "access_token": "xxxxx",
  "client_id": "bxxxxx2",
  "nbf": 1496787431,
  "iat": 1496787431,
  "application_name": "3ec63973-cda4-4d88-bc88-8e9ca557b8d4",
  "scopes": [
    ""
  ],
  "exp": 1496787731
}
```
## Enable Key Rotation
Key rotation is enabled through [JSON Web Keys](https://tools.ietf.org/html/rfc7517). The edgemicro-auth proxy exposes a new endpoint `/edgemicro-auth/jwkPublicKeys`. 

Here is a sample output:
```
{
  "keys": [
    {
      "kid": "1",
      "kty": "RSA",
      "n": "wJ7ctjvoL0gSM1wUvebyf0RWXxuWmHb1Q8rsRbhB8LLnSk04PgfwxiCVA1LJgrKP7jLZfg_ttpUNrHGmfJBzYpBwS6FhVBbKvZ2eq9ufeF_bm71Piqi2UZRiYNYFUcBHTYtM5NRbir1VI_aJD0WLTlLWrN3jbvRQbUR8nVib0M9eu5GJOdwN46zqXyJVTHzjJ3jT8qUaBCZoUVsDfdhRKMH3_y6AbyZHNUr7EVPbEqrhWmpd2djnnz_7pl2cJ8hYkqLRBOnXIHZ9KDI9F-v9Cf6KkSOi_JE1XcNumAIqXxyE-8VtL0keB-j4wzJLK16B287xJX5j-XB_a-3-evlZ8Q",
      "e": "AQAB"
    }
  ]
}
```


### Config File
Add a new field to the config file as below. This instructs the microgateway to use JSON Web Keys (and therefore support key rotation).
```
edge_config:
  bootstrap: >-
    https://edgemicroservices-us-east-1.apigee.net/edgemicro/bootstrap/organization/amer-demo13/environment/test
  jwt_public_key: 'https://amer-demo13-test.apigee.net/edgemicro-auth/publicKey'
  jwk_public_keys: 'https://amer-demo13-test.apigee.net/edgemicro-auth/jwkPublicKeys'
```

## Rotate Keys Tool
This tool will generate a new key/cert pair and update the encrypted with the new values.

After running this tool, the KVM values are:
```
private_key: <contains the New RSA Private Key>
private_key_kid: <contains the new KID for the private key; set to 2 for example>
public_key: New Certificate
public_key1: New Public Key
public_key1_kid: 2 <same as private_key_kid>
public_key2: Old Public Key
public_key2_kid: Old kid <default is 1>
```

The edgemicro-auth's JWK endpoint now returns multiple keys. 

Here is a sample output:
```
{
  "keys": [
    {
      "kty": "RSA",
      "n": "nSl7R_0wKLiWi6cO3n8aOJwYGBtinq723Jgg8i7KKWTSTYoszOjgGsJf_MX4JEW1YCScwpE5o4o8ccQN09iHVTlIhk8CNiMZNPipClmRVjaL_8IWvMQp1iN66qy4ldWXzXnHfivUZZogCkBNqCz7VSC5rw2Jf57pdViULVvVDGwTgf46sYveW_6h8CAGaD0KLd3vZffxIkoJubh0yMy0mQP3aDOeIGf_akeZeZ6GzF7ltbKGd954iNTiKmdm8IKhz6Y3gLpC9iwQ-kex_j0CnO_daHl1coYxUSCIdv4ziWIeM3dmjQ5_2dEvUDIGG6_Az9hTpNgPE5J1tvrOHAmunQ",
      "e": "AQAB",
      "kid": "2"
    },
    {
      "kty": "RSA",
      "n": "8BKwzx34BMUcHwTuQtmp8LFRCMxbkKg_zsWD6eOMIUTAsORexTGJsTy7z-4aH0wJ3fT-3luAAUPLBQwGcuHo0P1JnbtPrpuYjaJKSZOeIMOnlryJCspmv-1xG4qAqQ9XaZ9C97oecuj7MMoNwuaZno5MvsY-oi5B_gqED3vIHUjaWCErd4reONyFSWn047dvpE6mwRhZbcOTkAHT8ZyKkHISzopkFg8CD-Mij12unxA3ldcTV7yaviXgxd3eFSD1_Z4L7ZRsDUukCJkJ-8qY2-GWjewzoxl-mAW9D1tLK6qAdc89yFem3JHRW6L1le3YK37-bs6b2a_AqJKsKm5bWw",
      "e": "AQAB",
      "kid": "1"
    }
  ]
}
```

## OAuth Plugin
The microgateway OAuth plugin decodes the JWT and looks for the kid. If a kid is found, then the plugin will validate it against the JWK public key whose kid matches that of the JWT.
